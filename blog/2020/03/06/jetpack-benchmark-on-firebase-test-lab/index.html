<!doctype html><html lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Cache-Control content="public"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=Content-Security-Policy content="frame-src https://www.youtube.com/embed/;"><meta name=generator content="Hugo 0.150.0"><title>Jetpack Benchmark on Firebase Test Lab â€¢ Andy Dyer</title><meta name=twitter:card content="summary"><meta name=twitter:title content="Jetpack Benchmark on Firebase Test Lab"><meta name=twitter:description content="As previously outlined in my talk at Mobius Conference in Saint Petersburg last year, our team at Zalando is building a server-driven UI platform we call AppCraft. AppCraft allows us to add or update screens in our app with only server changes instead of the normal app release constrained way of doing things.
On the client side, we are building every screen the same way: fetch layout & data from the server, parse it, and render it."><meta property="og:url" content="https://andydyer.org/blog/2020/03/06/jetpack-benchmark-on-firebase-test-lab/"><meta property="og:site_name" content="Andy Dyer"><meta property="og:title" content="Jetpack Benchmark on Firebase Test Lab"><meta property="og:description" content="As previously outlined in my talk at Mobius Conference in Saint Petersburg last year, our team at Zalando is building a server-driven UI platform we call AppCraft. AppCraft allows us to add or update screens in our app with only server changes instead of the normal app release constrained way of doing things.
On the client side, we are building every screen the same way: fetch layout & data from the server, parse it, and render it."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-03-06T10:30:55+01:00"><meta property="article:modified_time" content="2020-03-06T10:30:55+01:00"><link rel=stylesheet href=https://andydyer.org/scss/hyde-hyde.8d4a958e8a5a3e3358bc9061aef41d5fb922f553dd6da59906472e8aaa5f4a48.css integrity="sha256-jUqVjopaPjNYvJBhrvQdX7ki9VPdbaWZBkcuiqpfSkg="><link rel=stylesheet href=https://andydyer.org/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58+TzH3icCkSHGoJ+ed7w=" media=print><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://andydyer.org/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://andydyer.org/favicon.png></head><body class=theme-base-0g><div class=sidebar><div class=container><div class=sidebar-about><div class=author-image><a href=https://andydyer.org/><img src="https://www.gravatar.com/avatar/e0ac1256093c733a5d5a26085b90966f?s=240&d=mp" class="img--circle img--headshot element--center" alt=gravatar></a></div><span class=site__title><a href=https://andydyer.org/>Andy Dyer</a></span><p class=site__description>Staff Platform Engineer at Ibotta, editor at ProAndroidDev</p></div><div class=collapsible-menu><input type=checkbox id=menuToggle>
<label for=menuToggle>Andy Dyer</label><div class=menu-content><div><ul class=sidebar-nav><li><a href=https://andydyer.org/categories/android><span>Android</span></a></li><li><a href=https://andydyer.org/categories/speaking><span>Speaking</span></a></li><li><a href=https://andydyer.org/blog/2009/04/19/bands-ive-seen-live><span>Bands I've Seen Live</span></a></li></ul></div><section class=social><a href=https://linkedin.com/in/abdyer rel=me><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a>
<a href=https://github.com/abdyer rel=me><i class="fab fa-github fa-lg" aria-hidden=true></i></a>
<a href=https://mastodon.social/@andydyer rel=me><i class="fab fa-mastodon fa-lg" aria-hidden=true></i></a></section></div></div></div></div><div class="content container"><article><header><h1>Jetpack Benchmark on Firebase Test Lab</h1><div class=post__meta><i class="fas fa-calendar-alt"></i> Mar 06, 2020
in
<a class="badge badge-category" href=https://andydyer.org/categories/android>ANDROID</a><br><i class="fas fa-clock"></i> 5 min read</div></header><div class=post><p>As previously outlined in my <a href=http://andydyer.org/blog/2019/12/22/appcraft-faster-than-a-speeding-release-train/>talk at Mobius Conference</a> in Saint Petersburg last year, our team at Zalando is building a server-driven UI platform we call AppCraft. AppCraft allows us to add or update screens in <a href="https://play.google.com/store/apps/details?id=de.zalando.mobile">our app</a> with only server changes instead of the normal app release constrained way of doing things.</p><p>On the client side, we are building every screen the same way: fetch layout & data from the server, parse it, and render it.</p><p>Since the API response time is mostly our of our control, this leaves:</p><ol><li>JSON parsing</li><li>Building the UI component tree (we currently use <a href=https://github.com/facebook/litho>Litho</a> for this)</li><li>Rendering</li></ol><p>The size of the response JSON and the complexity of the layout varies per screen, so benchmarking the above steps for each screen (we currently have three of them live in the app!) seemed like a good way to start tracking the performance of our library and its change over time.</p><h3 id=jetpack-benchmark-library>Jetpack Benchmark library</h3><p>My goal here is to share how to get benchmarks running on Firebase Test Lab, so I won&rsquo;t spend long telling you about the Jetpack Benchmark library itself; Google has <a href=https://developer.android.com/studio/profile/benchmark>already done that</a>. However, there are a couple of things worth mentioning.</p><h4 id=respect-your-tools>Respect your tools</h4><p>Would you carelessly grab a sharp knife by the blade? Probably not. The same applies here. Any good load testing or benchmarking tool can become a denial-of-service attack if (ab)used (in)correctly. The Jetpack Benchmark library does whatever you tell it to over and over as quickly as possible. Therefore, you <strong>do not</strong> want to make API requests to production servers (or probably any server) in your tests. Benchmark tests should run on isolated portions of your code that you want to profile. Mock API responses or any dependencies that you don&rsquo;t want to be affected by multiple rapid iterations.</p><h4 id=project-setup>Project setup</h4><p>The <a href=https://developer.android.com/studio/profile/benchmark>official docs</a> explain how to add the benchmark library to your project and important details such as the need to disable debugging for your app while benchmarking for accurate test results. They also mention that tests go in the benchmark module and the target code must be in a library.</p><p>In order to configure your app for running benchmarks (loading mocked responses from local files instead of hitting live endpoints, for example), it may also be helpful to add a custom <code>Application</code> and <code>Activity</code> to the target library&rsquo;s <code>debug</code> source set.</p><h3 id=benchmarks-on-ci>Benchmarks on CI</h3><p>Chris Craik from Google published <a href=https://medium.com/androiddevelopers/fighting-regressions-with-benchmarks-in-ci-6ea9a14b5c71>this article</a> last fall about how they&rsquo;re comparing benchmark results over time to spot regressions. The article has a lot of great detail about the challenges of doing such a comparison. It also inspired me to try running benchmarks on Jenkins and Firebase Test Lab (FTL), which we use for CI on our project.</p><h4 id=firebase-test-lab-flank--fladle>Firebase Test Lab, Flank & Fladle</h4><p>If you&rsquo;re here to learn about running benchmarks on FTL, chances are you&rsquo;re familiar with <a href=https://github.com/Flank/flank>Flank</a> and <a href=https://github.com/runningcode/fladle>Fladle</a>. We use these to configure the devices to use for each group of tests (screen shot tests, benchmarks, other UI tests) and how the tests run (in parallel, retries on failure, etc).</p><p>Unfortunately, as I learned, configuring the benchmark library on Jenkins and FTL comes with a couple of interesting challenges:</p><ol><li>FTL runs tests on physical devices that are not directly attached to the build machine. This means the benchmark library&rsquo;s default behavior of copying JSON results from the device to the build machine won&rsquo;t work.</li><li>The docs for <a href=https://developer.android.com/studio/profile/run-benchmarks-in-ci>running benchmarks on CI</a> tell us to set the <code>androidx.benchmark.output.enable</code> environment variable to <code>true</code> via the command line. It turns out environment variables with dots in them are not valid on FTL. We tried escaping them in various ways, but were unsuccessful.</li></ol><h3 id=benchmarks-on-ftl--jenkins>Benchmarks on FTL & Jenkins</h3><p>To solve our two challenges, we&rsquo;ll need a few ingredients. We&rsquo;ll look at each and the relevant code/build script snippets for them below:</p><ol><li>A custom <code>AndroidBenchmarkRunner</code> to output results JSON</li><li>A <code>@BenchmarkTest</code> annotation to group our benchmark tests</li><li>Fladle config to specify a physical device, copy results from the device</li><li>Run benchmarks with Flank, publish results JSON to artifacts in Jenkins pipeline script</li></ol><h4 id=custom-benchmark-runner-class>Custom benchmark runner class</h4><p>We need a custom <code>Application</code> class to set up the appropriate mocks for our benchmark tests. With a custom <code>AndroidBenchmarkRunner</code> class, we can create an instance of our <code>BenchmarkApp</code> class. We can also add the problematic environment variable to enable JSON output in the <code>Bundle</code> argument to the runner&rsquo;s <code>onCreate()</code> function:</p><script src=https://gist.github.com/abdyer/053a04804d2d1cafcafd8ba7f54a8877.js></script><p>Then, update the benchmark module&rsquo;s <code>build.gradle</code> to use the custom runner:</p><script src=https://gist.github.com/abdyer/0369db76e4c3ec9e1379e72198deee1d.js></script><h4 id=benchmark-test-annotation>Benchmark test annotation</h4><p>Benchmark tests will likely run separately from other UI tests since they require (or are at least strongly encouraged to be run on) a physical device and don&rsquo;t need to run as often as other types of tests. Initially, we scheduled our benchmarks to run weekly. Marking the tests with a custom annotation will allow us to filter them in our Fladle config:</p><script src=https://gist.github.com/abdyer/b65d0e57b871455cebf06c0849952408.js></script><h4 id=fladle-config>Fladle config</h4><p>Next, configure <a href=https://github.com/runningcode/fladle>Fladle</a> to run our tests on a physical device and download the results:</p><ul><li><code>devices</code> - specifies the FTL device configuration options (learn more about available configurations <a href=https://firebase.google.com/docs/test-lab/android/available-testing-devices>here</a>)</li><li><code>directoriesToPull</code> and <code>filesToDownload</code> - grabs everything in the device&rsquo;s <code>Download</code> directory</li><li><code>testTargets</code> - filters this task to only benchmark tests tagged with our <code>@BenchmarkTest</code> annotation</li></ul><script src=https://gist.github.com/abdyer/232ec78ee0f640bf9d332ba80a3d30bd.js></script><h4 id=running-benchmarks--saving-results>Running benchmarks & saving results</h4><p>Finally, we&rsquo;re ready to run our benchmark tests with <a href=https://github.com/Flank/flank>Flank</a>. By convention, a Gradle task is created from our Fladle config, the name of which is prepended with <code>runFlank</code> to become <code>runFlankBenchmarkTests</code> in our case. In our Jenkins pipeline script, we include the module name to run the benchmark tests with <code>benchmark:runFlankBenchmarkTests</code>.</p><p>After the tests run, all that&rsquo;s left is to use <a href=https://jenkinsci.github.io/job-dsl-plugin/#method/javaposse.jobdsl.dsl.helpers.publisher.PublisherContext.archiveArtifacts><code>archiveArtifacts</code></a> from the Jenkins Job DSL to add the results to the job artifacts:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>archiveArtifacts</span> <span style=color:#a6e22e>allowEmptyArchive</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>artifacts</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;**/*.json&#39;</span>
</span></span></code></pre></div><h3 id=conclusion>Conclusion</h3><p>As we&rsquo;ve seen, we can use the Jetpack Benchmark library to benchmark our code on Firebase Test Lab by adding a few missing ingredients. Weekly benchmark results will allow us to monitor the performance of our rendering library over time, but automatically parsing & charting the results and spotting regressions would be even more powerful. If you have suggestions for Linux friendly plotting libraries, please let me know!</p><p>And if you&rsquo;re interested in working on interesting problems like this while building Android apps used by tens of millions of users, check out our <a href=https://jobs.zalando.com/en/tech/jobs>open positions</a>!</p></div><div class="navigation navigation-single"><a href=https://andydyer.org/blog/2019/12/23/top-albums-of-2019/ class=navigation-prev><i aria-hidden=true class="fa fa-chevron-left"></i>
<span class=navigation-tittle>Top Albums of 2019</span>
</a><a href=https://andydyer.org/blog/2020/12/22/top-albums-of-2020/ class=navigation-next><span class=navigation-tittle>Top Albums of 2020</span>
<i aria-hidden=true class="fa fa-chevron-right"></i></a></div></article></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-PEEF2LV798"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PEEF2LV798")}</script><script defer src=https://use.fontawesome.com/releases/v5.11.2/js/all.js integrity=sha384-b3ua1l97aVGAPEIe48b4TC60WUQbQaGi2jqAWM90y0OZXZeyaTCWtBTKtjW2GXG1 crossorigin=anonymous></script></body></html>