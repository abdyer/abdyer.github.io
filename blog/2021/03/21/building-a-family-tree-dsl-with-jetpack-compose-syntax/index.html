<!doctype html><html lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=Cache-Control content="public"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=Content-Security-Policy content="frame-src https://www.youtube.com/embed/;"><meta name=generator content="Hugo 0.124.1"><title>Building a Family Tree DSL with Jetpack Compose syntax • Andy Dyer</title>
<meta name=twitter:card content="summary"><meta name=twitter:title content="Building a Family Tree DSL with Jetpack Compose syntax"><meta name=twitter:description content="Originally published on ProAndroidDev
Why build a DSL? Ever since first getting into Kotlin, I&rsquo;ve known it has a few things that makes building domain-specific languages (DSLs) easier. I&rsquo;ve read the mind-expanding type-safe builders guide for building a DSL for HTML, but until recently I hadn&rsquo;t found a good use case for building a DSL of my own.
My team at Zalando maintains server-driven UI libraries for Android & iOS that power completely dynamic screens such as home, brand homes, collections, and various landing pages in the Zalando fashion store apps."><meta property="og:title" content="Building a Family Tree DSL with Jetpack Compose syntax"><meta property="og:description" content="Originally published on ProAndroidDev
Why build a DSL? Ever since first getting into Kotlin, I&rsquo;ve known it has a few things that makes building domain-specific languages (DSLs) easier. I&rsquo;ve read the mind-expanding type-safe builders guide for building a DSL for HTML, but until recently I hadn&rsquo;t found a good use case for building a DSL of my own.
My team at Zalando maintains server-driven UI libraries for Android & iOS that power completely dynamic screens such as home, brand homes, collections, and various landing pages in the Zalando fashion store apps."><meta property="og:type" content="article"><meta property="og:url" content="https://andydyer.org/blog/2021/03/21/building-a-family-tree-dsl-with-jetpack-compose-syntax/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-03-21T20:05:20+01:00"><meta property="article:modified_time" content="2021-03-21T20:05:20+01:00"><link rel=stylesheet href=https://andydyer.org/scss/hyde-hyde.8d4a958e8a5a3e3358bc9061aef41d5fb922f553dd6da59906472e8aaa5f4a48.css integrity="sha256-jUqVjopaPjNYvJBhrvQdX7ki9VPdbaWZBkcuiqpfSkg="><link rel=stylesheet href=https://andydyer.org/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58+TzH3icCkSHGoJ+ed7w=" media=print><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://andydyer.org/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://andydyer.org/favicon.png></head><body class=theme-base-0g><div class=sidebar><div class=container><div class=sidebar-about><div class=author-image><a href=https://andydyer.org/><img src="https://www.gravatar.com/avatar/e0ac1256093c733a5d5a26085b90966f?s=240&d=mp" class="img--circle img--headshot element--center" alt=gravatar></a></div><span class=site__title><a href=https://andydyer.org/>Andy Dyer</a></span><p class=site__description>Staff Platform Engineer <a href=https://twitter.com/ibottatech>@IbottaTech</a>, editor <a href=https://twitter.com/proandroiddev>@ProAndroidDev</a></p></div><div class=collapsible-menu><input type=checkbox id=menuToggle>
<label for=menuToggle>Andy Dyer</label><div class=menu-content><div><ul class=sidebar-nav><li><a href=https://andydyer.org/categories/android><span>Android</span></a></li><li><a href=https://andydyer.org/categories/speaking><span>Speaking</span></a></li><li><a href=https://andydyer.org/blog/2009/04/19/bands-ive-seen-live><span>Bands I've Seen Live</span></a></li></ul></div><section class=social><a href=https://linkedin.com/in/abdyer rel=me><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a>
<a href=https://github.com/abdyer rel=me><i class="fab fa-github fa-lg" aria-hidden=true></i></a>
<a href=https://mastodon.social/@andydyer rel=me><i class="fab fa-mastodon fa-lg" aria-hidden=true></i></a></section></div></div></div></div><div class="content container"><article><header><h1>Building a Family Tree DSL with Jetpack Compose syntax</h1><div class=post__meta><i class="fas fa-calendar-alt"></i> Mar 21, 2021
in
<a class="badge badge-category" href=https://andydyer.org/categories/jetpack-compose>JETPACK COMPOSE</a>
•
<a class="badge badge-category" href=https://andydyer.org/categories/kotlin>KOTLIN</a>
•
<a class="badge badge-category" href=https://andydyer.org/categories/programming>PROGRAMMING</a><br><i class="fas fa-clock"></i> 6 min read</div></header><div class=post><blockquote><p>Originally published on <a href=https://proandroiddev.com/building-a-family-tree-dsl-with-jetpack-compose-syntax-fe652ce6cb0f>ProAndroidDev</a></p></blockquote><h3 id=why-build-a-dsl>Why build a DSL?</h3><p>Ever since first getting into Kotlin, I&rsquo;ve known it has a few things that makes building domain-specific languages (DSLs) easier. I&rsquo;ve read the mind-expanding <a href=https://kotlinlang.org/docs/type-safe-builders.html>type-safe builders</a> guide for building a DSL for HTML, but until recently I hadn&rsquo;t found a good use case for building a DSL of my own.</p><p><a href=https://jobs.zalando.com/en/jobs/2986308-senior-android-engineer-appcraft-mobile>My team at Zalando</a> maintains server-driven UI libraries for Android & iOS that power completely dynamic screens such as home, brand homes, collections, and various landing pages in the <a href="https://play.google.com/store/apps/details?id=de.zalando.mobile">Zalando fashion</a> <a href="https://apps.apple.com/de/app/zalando-fashion-shopping/id585629514?l=en">store apps</a>. Often, we need to build mock responses during development for new features that don&rsquo;t have a backend implementation yet or models for unit tests. In the past, we&rsquo;d grab chunks of JSON from API responses and edit them, but navigating a wall of text is tedious and editing JSON is far less fun than writing code.</p><p>Even once I had the use case, it took spending some time with <a href=https://developer.android.com/jetpack/compose>Jetpack Compose</a> for everything to finally &ldquo;click&rdquo;. I noticed how the <code>Column</code> composable used a <code>ColumnScope.()</code> receiver for its lambda block (as do most composables, it turns out). It was this detail and a quick look at the source code that helped me realize that the receiver was the piece I was missing to build a nice, clean DSL with the same syntax as Compose.</p><p>To keep things simple, we&rsquo;ll see how to apply these same ideas to building a family tree DSL.</p><h3 id=what-is-the-desired-syntax>What is the desired syntax?</h3><p>Our goal is to build a DSL with a syntax similar to Jetpack Compose. This means <a href=https://kotlinlang.org/docs/functions.html#named-arguments>functions with named arguments</a> and a <a href=https://kotlinlang.org/docs/lambdas.html#passing-trailing-lambdas>trailing lambda for the last parameter</a> that uses a <a href=https://kotlinlang.org/docs/lambdas.html#function-literals-with-receiver>receiver</a> to scope the functions called inside:</p><script src=https://gist.github.com/abdyer/ad110ca703578c68782c0cd1bb0fe3e0.js></script><p>That last sentence contained a lot of concepts in a few words, so let&rsquo;s take a quick look at each.</p><h4 id=functions-with-named-arguments>Functions with named arguments</h4><p>Everything in Compose is a function and we understand what named arguments are, but the combination of these allows us to pack all the information we need about an entity in a well-known unit. The function name tells us what the item is while its named arguments & values tell us its most important details. Default values can be provided to allow flexibility while optimizing for the most common use case.</p><p>With no prior knowledge of Compose, we immediately know from the brief code block above that we&rsquo;re dealing with a column that has <code>16 dp</code> of padding around its contents. We can also surmise that a <code>Modifier</code> must be how style related attributes are specified.</p><h4 id=trailing-lambdas>Trailing lambdas</h4><p>Functions and named arguments describe an entity, but UIs (and family trees) also need a way to indicate hierarchy. Kotlin&rsquo;s trailing lambdas allow us to pass a function as the last argument to a function outside the closing parenthesis which gives us a nice curly brace wrapper around another function. But UI and family tree parents can both have multiple children, so a single function does not quite give us the syntax we want. Maybe there&rsquo;s a way to scope multiple function calls and have a single class or object &ldquo;receive&rdquo; them&mldr;</p><h4 id=receivers--scope>Receivers & scope</h4><p>By declaring our trailing lambda as <code>A.(B) -> C</code>, we scope the functions called inside (<code>B</code>) to class <code>A</code>, returning type <code>C</code> (which can also be <code>Unit</code>). It&rsquo;s also a good idea to create our own <a href=https://kotlinlang.org/docs/type-safe-builders.html#scope-control-dslmarker><code>@DslMarker</code> annotations</a> and apply them to our DSL classes.</p><h3 id=family-tree-dsl-design-considerations>Family tree DSL design considerations</h3><p>Armed these concepts to achieve a Compose like syntax, we can turn our attention to modeling a family tree. A family tree is essentially a recursive hierarchy of partnerships and children. Our family tree DSL will behave as follows:</p><ol><li>A family groups a member and partnerships.</li><li>A partnership is a relationship between two people, with one of them being the family member. Each partnership can have one or more children. Each of those children can have their own family and so on.</li></ol><h3 id=building-the-dsl>Building the DSL</h3><p>Time for the code! Let&rsquo;s go through each of the classes and functions that compose our DSL. We&rsquo;ll start with the people before moving on to the partnerships and finally the family to create the family tree hierarchy.</p><h4 id=people>People</h4><p>Just like <a href="https://www.youtube.com/watch?v=Xs-gocza6t8">Soylent Green</a>, families are made out of people! We can use a <a href=https://kotlinlang.org/docs/sealed-classes.html><code>sealed class</code></a> to define a <code>Person</code> with a <code>name</code>. A <code>Person</code> can either be <code>Unidentified</code> (we&rsquo;ll see why this is useful in the next post) or a <code>FamilyMember</code> where more details about the person may be known:</p><script src=https://gist.github.com/abdyer/a268367c77800cd4c5340726eb847032.js></script><h4 id=partnerships>Partnerships</h4><p>To model a relationship between two people and their children, we&rsquo;ll need a <code>Partnership</code>. Below we define a custom <code>@DslMarker</code> and a <code>Partnership</code> class with a <code>child()</code> function for adding <code>children</code>:</p><script src=https://gist.github.com/abdyer/51dd031ef4d6e434aaa55d8de7c67f26.js></script><p>The final <code>block</code> parameter passed to the <code>child()</code> function is our first use of the trailing-lambda-scoped-to-a-receiver secret sauce. We&rsquo;ll dig into the <code>Family</code> class next, but before we move on, there are a couple more things to note:</p><ul><li>The first is how <code>block()</code> is called on the <code>Family</code> instance after we create it. This has the effect of executing all of the function calls inside the lambda on this <code>Family</code>, thereby adding their partnerships & children (and children&rsquo;s families, etc.).</li><li>The other is how the <code>Family</code> is added to the <code>Partnership</code> children internally. This allows us to build the list of<code>children</code> for subsequent inspection and still return the new <code>Family</code> instance for further tree construction as we&rsquo;ll see next.</li></ul><h4 id=family>Family</h4><p>After defining another custom <code>@DslMarker</code>, we can create a <code>Family</code> class that groups a <code>FamilyMember</code> and <code>Partnership</code> list. In general, it&rsquo;s the same pattern we saw in the <code>Partnership</code> class above, only this time we&rsquo;re adding to a <code>partnerships</code> list with a <code>partner()</code> function. There are two here for convenience, making it possible to add a <code>Partnership</code> with two different sets of parameters (also useful in the next post):</p><script src=https://gist.github.com/abdyer/1bfec8b9780d13b93c36700f10c8f67a.js></script><h4 id=one-more-function>One more function</h4><p>We need one more function to tie everything together. It will create our root <code>FamilyMember</code> and <code>Family</code> instances, call the family <code>block()</code>, and return the resulting <code>Family</code>:</p><script src=https://gist.github.com/abdyer/ce812fa7424413b6bfdb78d54ac88a7e.js></script><h3 id=using-the-dsl>Using the DSL</h3><p>Now we can use the DSL to create family trees like the one below with a Compose like syntax:</p><script src=https://gist.github.com/abdyer/c838ebb995850c1fab59f43c9cefeb35.js></script><h3 id=conclusion>Conclusion</h3><p>In this post, we have seen how to combine <a href=https://kotlinlang.org/docs/functions.html#named-arguments>functions with named arguments</a>, <a href=https://kotlinlang.org/docs/lambdas.html#passing-trailing-lambdas>trailing lambdas</a>, and <a href=https://kotlinlang.org/docs/lambdas.html#function-literals-with-receiver>receivers</a> to build a family tree DSL with a syntax inspired by Jetpack Compose.</p><p>I decided to save the analysis of the plot-spoiling family trees I built from <a href=https://dark.netflix.io>Netflix&rsquo;s Dark series web site</a> for a follow-up post, but they&rsquo;re in <a href=https://github.com/abdyer/family-tree-dsl>the same repo</a> as the code. I think the time travel aspect makes things even more interesting and modeling &ldquo;the knot&rdquo; using the DSL was a fun little project. I came away from it with a slightly better understanding of the story as well as an even deeper appreciation for its hidden genius.</p><p>Thanks for reading and stay tuned for the Dark follow-up!</p></div><div class="navigation navigation-single"><a href=https://andydyer.org/blog/2021/03/16/flexbox-layout-behavior-in-jetpack-compose/ class=navigation-prev><i aria-hidden=true class="fa fa-chevron-left"></i>
<span class=navigation-tittle>Flexbox Layout Behavior in Jetpack Compose</span>
</a><a href=https://andydyer.org/blog/2021/05/01/spoiling-the-dark-plot-with-kotlin/ class=navigation-next><span class=navigation-tittle>Spoiling the Dark plot with Kotlin</span>
<i aria-hidden=true class="fa fa-chevron-right"></i></a></div></article></div><script>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-48421946-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><script defer src=https://use.fontawesome.com/releases/v5.11.2/js/all.js integrity=sha384-b3ua1l97aVGAPEIe48b4TC60WUQbQaGi2jqAWM90y0OZXZeyaTCWtBTKtjW2GXG1 crossorigin=anonymous></script></body></html>